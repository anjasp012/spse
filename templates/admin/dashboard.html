{% extends "admin/base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/admin">Admin</a></li>
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block extra_style %}
<!-- No custom style needed, using Bootstrap 4 native classes -->
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row">
    <!-- Total Users -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_users }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Users -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Active Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_users }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tender -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Data Tender
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_tender }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-gavel fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Non-Tender -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Data Non-Tender</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_nontender }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-handshake fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fetch Data Section -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Fetch Data Tender</h6>
            </div>
            <div class="card-body">
                <p>Ambil data tender terbaru dari SPSE.</p>
                <div class="form-group">
                    <label for="fetchTahunTender">Pilih Tahun:</label>
                    <select class="form-control" id="fetchTahunTender">
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-block" id="fetchTenderBtn">
                    <i class="fas fa-download mr-2"></i> Fetch Data Tender
                </button>
                <!-- Progress Bar Tender -->
                <div id="progressContainerTender" class="mt-3 d-none">
                    <div class="progress">
                        <div id="progressBarTender" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted mt-1 d-block text-center" id="progressTextTender">Sedang memproses...</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-warning">Fetch Data Non-Tender</h6>
            </div>
            <div class="card-body">
                <p>Ambil data non-tender terbaru dari SPSE.</p>
                <div class="form-group">
                    <label for="fetchTahunNonTender">Pilih Tahun:</label>
                    <select class="form-control" id="fetchTahunNonTender">
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                <button class="btn btn-warning btn-block text-white" id="fetchNonTenderBtn">
                    <i class="fas fa-download mr-2"></i> Fetch Data Non-Tender
                </button>
                <!-- Progress Bar Non-Tender -->
                <div id="progressContainerNonTender" class="mt-3 d-none">
                    <div class="progress">
                        <div id="progressBarNonTender" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted mt-1 d-block text-center" id="progressTextNonTender">Sedang memproses...</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Fetch Data Tender
    document.getElementById('fetchTenderBtn').addEventListener('click', function() {
        const tahun = document.getElementById('fetchTahunTender').value;
        const btn = this;
        const progressContainer = document.getElementById('progressContainerTender');
        const progressBar = document.getElementById('progressBarTender');
        const progressText = document.getElementById('progressTextTender');

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Fetching...';

        // Show progress bar
        progressContainer.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressText.textContent = 'Memulai proses...';

        // Call API to start scraping
        fetch(`/api/start-scraping-tender?tahun=${tahun}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'loading') {
                // Poll progress
                checkProgressTender();
            } else {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = data.message || 'Selesai!';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Tender';
                    progressContainer.classList.add('d-none');
                    location.reload(); // Reload to update stats
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            progressText.textContent = 'Error: ' + error.message;
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-danger');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Tender';
                progressContainer.classList.add('d-none');
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-primary');
            }, 3000);
        });
    });

    // Check progress for Tender
    function checkProgressTender() {
        const progressBar = document.getElementById('progressBarTender');
        const progressText = document.getElementById('progressTextTender');
        const btn = document.getElementById('fetchTenderBtn');

        const intervalId = setInterval(() => {
            fetch('/api/tender-status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'loading') {
                        const progress = data.progress || 0;
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = progress + '%';
                        progressText.textContent = data.message || `Progress: ${progress}%`;
                    } else if (data.status === 'done') {
                        clearInterval(intervalId);
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressText.textContent = 'Selesai!';

                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Tender';
                            document.getElementById('progressContainerTender').classList.add('d-none');
                            location.reload();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                });
        }, 1000); // Check every second
    }

    // Fetch Data Non-Tender
    document.getElementById('fetchNonTenderBtn').addEventListener('click', function() {
        const tahun = document.getElementById('fetchTahunNonTender').value;
        const btn = this;
        const progressContainer = document.getElementById('progressContainerNonTender');
        const progressBar = document.getElementById('progressBarNonTender');
        const progressText = document.getElementById('progressTextNonTender');

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Fetching...';

        // Show progress bar
        progressContainer.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressText.textContent = 'Memulai proses...';

        // Call API to start scraping
        fetch(`/api/start-scraping-nontender?tahun=${tahun}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'loading') {
                // Poll progress
                checkProgressNonTender();
            } else {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = data.message || 'Selesai!';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Non-Tender';
                    progressContainer.classList.add('d-none');
                    location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            progressText.textContent = 'Error: ' + error.message;
            progressBar.classList.remove('bg-warning');
            progressBar.classList.add('bg-danger');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Non-Tender';
                progressContainer.classList.add('d-none');
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-warning');
            }, 3000);
        });
    });

    // Check progress for Non-Tender
    function checkProgressNonTender() {
        const progressBar = document.getElementById('progressBarNonTender');
        const progressText = document.getElementById('progressTextNonTender');
        const btn = document.getElementById('fetchNonTenderBtn');

        const intervalId = setInterval(() => {
            fetch('/api/nontender-status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'loading') {
                        const progress = data.progress || 0;
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = progress + '%';
                        progressText.textContent = data.message || `Progress: ${progress}%`;
                    } else if (data.status === 'done') {
                        clearInterval(intervalId);
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressText.textContent = 'Selesai!';

                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-download mr-2"></i> Fetch Data Non-Tender';
                            document.getElementById('progressContainerNonTender').classList.add('d-none');
                            location.reload();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                });
        }, 1000); // Check every second
    }

    console.log('Dashboard loaded - Fetch functionality initialized');
</script>
{% endblock %}
